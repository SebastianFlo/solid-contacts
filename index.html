<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible"
        content="ie=edge">
    <title>Profile Viewer - First Solid App</title>
    <link rel="stylesheet" href="/style.css">
</head>

<body>
    <h1>Profile viewer</h1>

    <p id="login">
        You are not logged in.
        <button>Login</button>
    </p>

    <div id="logout">
        You are logged in as <b id="user"></b>.

        <div>
            <label for="profile">Profile:</label>
            <input id="profile">
            <button id="view">View</button>

            <p id="name"></p>
            <ul id="friends"></ul>
        </div>

        <div>
            <button id="logout-b">Logout</button>
        </div>
    </div>

    <script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.3.1.min.js"></script>
    <script src="https://solid.github.io/solid-auth-client/dist/solid-auth-client.bundle.js"></script>
    <script src="https://linkeddata.github.io/rdflib.js/dist/rdflib.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', load);

        function load() {
            const loginEl = $('#login');
            const loginButton = $('#login button')

            const logoutEl = $('#logout');
            const logoutButton = $('#logout #logout-b')

            const userEl = $('#user');
            const profileEl = $('#profile');
            const nameEl = $('#name');
            const viewButton = $('#view');

            const popupUri = 'popup.html';
            const FOAF = $rdf.Namespace('http://xmlns.com/foaf/0.1/');

            init();
            setupSession();
            hookView();

            function init() {
                logoutEl.hide();
            }

            function setupSession() {
                loginButton.click(() => solid.auth.popupLogin({ popupUri }));
                logoutButton.click(() => solid.auth.logout());

                solid.auth.trackSession(session => {
                    const loggedIn = !!session;

                    loginEl.toggle(!loggedIn);
                    logoutEl.toggle(loggedIn);

                    if (loggedIn) {
                        const sessionId = session.webId;
                        userEl.text(sessionId);

                        if (!profileEl.val()) {
                            profileEl.val(sessionId);
                        }
                    }
                });
            }

            function hookView() {
                viewButton.click(async function loadProfile() {
                    // Set up a local data store and associated data fetcher
                    const store = $rdf.graph();
                    const fetcher = new $rdf.Fetcher(store);

                    // Load the person's data into the store
                    const person = profileEl.val();
                    await fetcher.load(person);

                    // Display their details
                    const fullName = store.any($rdf.sym(person), FOAF('name'));
                    nameEl.text(fullName && fullName.value);

                    const friends = store.each($rdf.sym(person), FOAF('knows'));
                    $('#friends').empty();
                    friends.forEach(async (friend) => {
                        await fetcher.load(friend);
                        const fullName = store.any(friend, FOAF('name'));
                        $('#friends').append(
                            $('<li>').append(
                                $('<a>').text(fullName && fullName.value || friend.value)
            	                        .click(() => profileEl.val(friend.value))
                                        .click(loadProfile)
                                )
                        )
                    });
                });
            }
        }
    </script>
</body>

</html>